access_log /var/log/nginx/access.log;
error_log /var/log/nginx/error.log;

# upstream app {
# 	least_conn;
# 	server react:5000 max_fails=3 fail_timeout=30s;
# }

upstream appdev {
	least_conn;
	server reactdev:3000 max_fails=3 fail_timeout=30s;
}

server {
	listen 0.0.0.0:80;
	server_name localhost;
	root /var/www/public/;

	location / {
		proxy_pass http://appdev;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection 'upgrade';
		proxy_set_header Host $host;
		proxy_cache_bypass $http_upgrade;
		break;
	}

	location /api {
        # try to serve file directly, fallback to index.php
        try_files $uri /index.php$is_args$args;
    }

	location /swagger.json {
        # try to serve file directly, fallback to index.php
        try_files $uri /index.php$is_args$args;
    }

	location /swagger {
		index index.html;
    }
  
  	location ~ ^/(index)\.php(/|$) {
		fastcgi_split_path_info ^(.+\.php)(/.*)$;
		include       /etc/nginx/fastcgi_params;
		fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
		send_timeout  1800;
		fastcgi_read_timeout 1800;
		fastcgi_pass  phpfpm:9000;
	}
}